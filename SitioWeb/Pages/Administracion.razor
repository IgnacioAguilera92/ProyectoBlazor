@page "/administracion"
@inject Principal Principal
@inject IJSRuntime JS

<div class="user-info">

    @* UNA VEZ LOGEADO
    <img src="img/user.svg" />
    <div>
    <a href="authentication/profile" class="username">ADMINISTRADOR</a>
    <button class="btn btn-link sign-out">Sign out</button>
    </div> *@
    @*<a class="sign-in" href="authentication/register">Registrarse</a>*@

    <MostrarAlerta @ref="Alert" />
    
    <a @ref="elementLimpiar" id="LimpiarAdmin" class="sign-in clear hidden" @onclick="Limpiar"><i class="fa-solid fa-trash" style="font-size:21px"></i></a>
    <a class="sign-in add" @onclick="AgregarProducto">TEST +</a>
    <a class="sign-in" href="authentication/login" style="width: 140px;height: 46px;">Iniciar Sesión</a>

    @* CARRITO *@
    <div class="shopping" title="Click para visualizar el carrito" @onclick="Carrito">
        <div id="cart" class="cart" data-totalitems="0">
            <i class="fas fa-shopping-cart"></i>
        </div>
        <span class="stock-rojo">
            @if (Principal.Carrito?.Productos.Count > 0)
            {
                @Principal.Carrito.Productos.Count
            }
            else
            {
                //DEFAULT
                @(0)
            }
        </span>
    </div>
</div>

@code {
    [Parameter] public EventCallback OnEvento { get; set; }
    private MostrarAlerta Alert;
    private ElementReference elementLimpiar;

    public void AgregarProducto()
    {
        var productos = Principal.GetProductos();
        if (productos?.Count > 0)
        {
            var ultimoId = productos.LastOrDefault().IdProducto + 1;

            Random random = new Random();
            int numeroRandom = random.Next(10000, 50001);
            int stockRandom = random.Next(3, 15);
            var producto = Principal.GetProducto(ultimoId, numeroRandom, stockRandom);
            JS.InvokeVoidAsync("mostrarLimpiar", elementLimpiar);
            Principal.AgregarProducto(producto);
            
        }
    }
    public async Task Limpiar()
    {
        var productos = Principal.GetProductos();
        if (productos?.Count > 4 || Principal.Carrito?.Productos.Count > 0)
        {
            var confirmado = await Alert.ConfirmAlert("¿Estas seguro de vaciar el carrito?", "", "warning");
            if (confirmado)
            {
                if (productos?.Count > 4)
                {
                    JS.InvokeVoidAsync("quitarLimpiar", elementLimpiar);
                    Principal.Limpiar();
                    
                    OnEvento.InvokeAsync(null);
                    Alert.ShowAlert("Productos Eliminados!", "Se han eliminado todos los productos menos los productos principales.", "success");
                    
                }
                else if (Principal.Carrito?.Productos.Count > 0)
                {
                    JS.InvokeVoidAsync("quitarLimpiar", elementLimpiar);
                    Principal.LimpiarCarrito();                    
                    Alert.ShowAlert("Carrito vaciado!", "Carrito se encuentra sin productos actualmente.", "success");
                    
                }
                else
                {
                    Alert.ShowAlert("Informativo", "No se ha podido eliminar los productos, los productos principales no se eliminan.", "warning");
                }
            }
        }
        else
        {
            JS.InvokeVoidAsync("quitarLimpiar", elementLimpiar);
            Alert.ShowAlert("Informativo", "No se ha podido eliminar los productos, los productos principales no se eliminan.", "warning");
        }
    }    
    protected override void OnInitialized()
    {
        // Suscribirse al evento de cambio para actualizar el componente
        Principal.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        // Desuscribirse del evento para evitar fugas de memoria
        Principal.OnChange -= StateHasChanged;
    }
    private void Carrito(MouseEventArgs e)
    {
        Alert.DefaultAlert("EN CONSTRUCCIÓN","","warning");
    }
}
<script>
    function mostrarLimpiar(element) {
        if (element) 
        {
             element.classList.remove('hidden');
             element.style.display = 'block';
        }
    }
    function quitarLimpiar(element) {
        if (element) 
        {
            element.classList.remove('block');
            element.style.display = 'hidden';
        }
    }
</script>
