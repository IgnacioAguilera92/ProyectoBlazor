
@using Entidades
@inject HttpClient HttpClient
@inject Principal Principal
@inject NavigationManager NavigationManager

<br />
<center>
    <MostrarAlerta @ref="Alert" />
    <div>
        <ul class="producto-cards">
            @if (productos is not null)
            {
                @foreach (var producto in productos)
                {
                    <li style="background-image: url('@producto.ImageUrl');">
                        <div class="producto-info">
                            <!--NOMBRE PRODUCTO -->
                            <span class="title">@producto.NombreProducto</span>
                            @producto.Descripcion
                            <!--VALORES-->
                            @if(producto.ConDescuento)
                            {
                                <span class="price-old"><s>$@CalcularValorOld(producto.Valor)</s></span>
                            }
                            <span class="price">@Principal.FormatearPesos(producto.Valor)</span>
                        </div>
                        <div class="page-wrapper">
                            <button style="margin-top:194px; cursor:pointer" class="add-to-cart" @onclick="() => AgregarCarrito(producto)">
                                Agregar carrito
                                <i class="fas fa-shopping-cart"/>
                            </button>
                            <!--STOCK-->
                           <div class="producto-stock" title="Cantidad de productos en venta">
                                <div class="stocks" >
                                    @if (@producto.Stock >= 10)
                                    {
                                        <span class="stock-verde" >
                                            @producto.Stock.ToString()
                                        </span>
                                    }
                                    else if (@producto.Stock > 0 && @producto.Stock < 10)
                                    {
                                        <span class="stock-naranjo">
                                            @producto.Stock.ToString()
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="stock-rojo">@producto.Stock.ToString()</span>
                                    }
                                </div>
                            </div>
                        </div>
                     </li>
                }
            }
        </ul>
    </div>
</center>  
@code
{
    List<Productos> productos = new List<Productos>();
    Order carrito = new Order();
    private MostrarAlerta Alert;

    protected override async Task OnInitializedAsync()
    {       
        //TEST - PRINCIPAL STOCK
        var producto1 = Principal.GetProducto(1, 20000, 1, 2, true);
        productos.Add(producto1);
        var producto2 = Principal.GetProducto(2, 15000, 2, 10);
        productos.Add(producto2);
        var producto3 = Principal.GetProducto(3, 35000, 3, 3);
        productos.Add(producto3);
        var producto4 = Principal.GetProducto(4, 23990, 4, 4, true);
        productos.Add(producto4);        

        Principal.Productos = productos;
        Principal.OnChange += StateHasChanged;
    }
    public void Dispose()
    {
        Principal.OnChange -= StateHasChanged;
    }
    public void AgregarCarrito(Productos producto)
    {
        if (producto.Stock > 0)
        {
            carrito = Principal.Carrito;

            if (carrito.Productos.Any(p => p.IdProducto == producto.IdProducto))
            {
                var productoExistente = carrito.Productos.FirstOrDefault(p => p.IdProducto == producto.IdProducto);

                if (productoExistente != null)
                {
                    productoExistente.Cantidad++;
                    productoExistente.ValorCantidad = productoExistente.Valor + producto.Valor; //REPETIDO
                }
            }
            else
            {
                producto.ValorCantidad = producto.Valor; //DEFAULT
                carrito.Productos.Add(producto);
            }
            carrito.CantidadProductos++;
            Principal.AgregarCarrito(carrito);
            producto.Stock--;
            var valorTotal = Principal.FormatearPesos(producto.Valor);
            Alert.CustomAlert($"Se agrego {producto.NombreProducto} al carrito! 🛒", valorTotal, "success", carrito, producto.ImageUrl);
        }
        else
        {
            Alert.ShowAlert("Sin Stock", "El producto seleccionado no tiene más stock, esperar que el administrador ingrese más.", "warning");
        }
    }

    public string CalcularValorOld(decimal valorProducto)
    {
        var valorOld = valorProducto + 10000;
        return $"{valorOld.ToString("N0", new System.Globalization.CultureInfo("es-CL"))}";
    }
}
